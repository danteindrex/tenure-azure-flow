# Tenure Platform - Complete Kubernetes Deployment
# This single file deploys all microservices for the Tenure platform
#
# Usage:
#   kubectl apply -f tenure-platform.yaml
#
# Prerequisites:
#   1. Build and push all Docker images to your registry
#   2. Update image references below with your registry URL
#   3. Create secrets with actual values (or use external secrets manager)

---
# Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: tenure
  labels:
    app.kubernetes.io/name: tenure-platform

---
# ConfigMap - Shared configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: tenure-config
  namespace: tenure
data:
  NODE_ENV: "production"

  # Service ports
  UI_PORT: "3000"
  SUBSCRIPTION_SERVICE_PORT: "3001"
  KYC_SERVICE_PORT: "3002"
  QUEUE_SERVICE_PORT: "3003"
  PAYOUT_SERVICE_PORT: "3004"

  # Internal service URLs (Kubernetes DNS)
  SUBSCRIPTION_SERVICE_URL: "http://subscription-service.tenure.svc.cluster.local:3001"
  KYC_SERVICE_URL: "http://kyc-service.tenure.svc.cluster.local:3002"
  QUEUE_SERVICE_URL: "http://queue-service.tenure.svc.cluster.local:3003"
  PAYOUT_SERVICE_URL: "http://payout-service.tenure.svc.cluster.local:3004"

  # CORS (update with your domain)
  ALLOWED_ORIGINS: "https://your-domain.com,http://localhost:3000"

---
# Secrets - REPLACE WITH ACTUAL VALUES or use sealed-secrets/external-secrets
apiVersion: v1
kind: Secret
metadata:
  name: tenure-secrets
  namespace: tenure
type: Opaque
stringData:
  # Database
  DATABASE_URL: "postgresql://user:password@host:5432/database"

  # Auth
  BETTER_AUTH_SECRET: "your-secret-here"
  BETTER_AUTH_URL: "https://your-domain.com"
  GOOGLE_CLIENT_ID: "your-google-client-id"
  GOOGLE_CLIENT_SECRET: "your-google-client-secret"

  # Stripe
  STRIPE_SECRET_KEY: "sk_test_xxx"
  STRIPE_PUBLISHABLE_KEY: "pk_test_xxx"
  STRIPE_WEBHOOK_SECRET: "whsec_xxx"

  # SMTP
  SMTP_HOST: "smtp.gmail.com"
  SMTP_PORT: "587"
  SMTP_USER: "your-email@gmail.com"
  SMTP_PASS: "your-app-password"
  EMAIL_FROM: "your-email@gmail.com"
  EMAIL_FROM_NAME: "Tenure"

  # Twilio
  TWILIO_ACCOUNT_SID: "your-sid"
  TWILIO_AUTH_TOKEN: "your-token"
  TWILIO_PHONE_NUMBER: "+1234567890"
  TWILIO_VERIFY_SERVICE_SID: "your-verify-sid"

  # Plaid
  PLAID_CLIENT_ID: "your-plaid-client-id"
  PLAID_SECRET: "your-plaid-secret"
  PLAID_ENV: "sandbox"

---
# ============================================
# SERVICE 1: UI (Next.js Frontend)
# ============================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ui
  namespace: tenure
  labels:
    app: ui
spec:
  replicas: 2
  selector:
    matchLabels:
      app: ui
  template:
    metadata:
      labels:
        app: ui
    spec:
      containers:
        - name: ui
          image: tenure/ui:latest  # UPDATE: your-registry/tenure-ui:tag
          ports:
            - containerPort: 3000
          envFrom:
            - configMapRef:
                name: tenure-config
            - secretRef:
                name: tenure-secrets
          env:
            - name: PORT
              value: "3000"
            - name: NEXT_PUBLIC_QUEUE_SERVICE_URL
              value: "http://queue-service.tenure.svc.cluster.local:3003"
            - name: NEXT_PUBLIC_SUBSCRIPTION_SERVICE_URL
              value: "http://subscription-service.tenure.svc.cluster.local:3001"
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: ui
  namespace: tenure
spec:
  type: ClusterIP
  ports:
    - port: 3000
      targetPort: 3000
  selector:
    app: ui

---
# ============================================
# SERVICE 2: Subscription Service (Stripe)
# ============================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: subscription-service
  namespace: tenure
  labels:
    app: subscription-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: subscription-service
  template:
    metadata:
      labels:
        app: subscription-service
    spec:
      containers:
        - name: subscription-service
          image: tenure/subscription-service:latest  # UPDATE: your-registry/tenure-subscription:tag
          ports:
            - containerPort: 3001
          envFrom:
            - configMapRef:
                name: tenure-config
            - secretRef:
                name: tenure-secrets
          env:
            - name: PORT
              value: "3001"
            - name: FRONTEND_URL
              value: "https://your-domain.com"
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          livenessProbe:
            httpGet:
              path: /health
              port: 3001
            initialDelaySeconds: 20
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 3001
            initialDelaySeconds: 10
            periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: subscription-service
  namespace: tenure
spec:
  type: ClusterIP
  ports:
    - port: 3001
      targetPort: 3001
  selector:
    app: subscription-service

---
# ============================================
# SERVICE 3: Queue Service (Member Queue)
# ============================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: queue-service
  namespace: tenure
  labels:
    app: queue-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: queue-service
  template:
    metadata:
      labels:
        app: queue-service
    spec:
      containers:
        - name: queue-service
          image: tenure/queue-service:latest  # UPDATE: your-registry/tenure-queue:tag
          ports:
            - containerPort: 3003
          envFrom:
            - configMapRef:
                name: tenure-config
            - secretRef:
                name: tenure-secrets
          env:
            - name: PORT
              value: "3003"
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          livenessProbe:
            httpGet:
              path: /health
              port: 3003
            initialDelaySeconds: 20
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 3003
            initialDelaySeconds: 10
            periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: queue-service
  namespace: tenure
spec:
  type: ClusterIP
  ports:
    - port: 3003
      targetPort: 3003
  selector:
    app: queue-service

---
# ============================================
# SERVICE 4: KYC Service (Plaid Identity)
# ============================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kyc-service
  namespace: tenure
  labels:
    app: kyc-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: kyc-service
  template:
    metadata:
      labels:
        app: kyc-service
    spec:
      containers:
        - name: kyc-service
          image: tenure/kyc-service:latest  # UPDATE: your-registry/tenure-kyc:tag
          ports:
            - containerPort: 3002
          envFrom:
            - configMapRef:
                name: tenure-config
            - secretRef:
                name: tenure-secrets
          env:
            - name: PORT
              value: "3002"
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          livenessProbe:
            httpGet:
              path: /health
              port: 3002
            initialDelaySeconds: 20
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 3002
            initialDelaySeconds: 10
            periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: kyc-service
  namespace: tenure
spec:
  type: ClusterIP
  ports:
    - port: 3002
      targetPort: 3002
  selector:
    app: kyc-service

---
# ============================================
# SERVICE 5: Payout Service (Rewards)
# ============================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: payout-service
  namespace: tenure
  labels:
    app: payout-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: payout-service
  template:
    metadata:
      labels:
        app: payout-service
    spec:
      containers:
        - name: payout-service
          image: tenure/payout-service:latest  # UPDATE: your-registry/tenure-payout:tag
          ports:
            - containerPort: 3004
          envFrom:
            - configMapRef:
                name: tenure-config
            - secretRef:
                name: tenure-secrets
          env:
            - name: PORT
              value: "3004"
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          livenessProbe:
            httpGet:
              path: /health
              port: 3004
            initialDelaySeconds: 20
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 3004
            initialDelaySeconds: 10
            periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: payout-service
  namespace: tenure
spec:
  type: ClusterIP
  ports:
    - port: 3004
      targetPort: 3004
  selector:
    app: payout-service

---
# ============================================
# INGRESS - External Access
# ============================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: tenure-ingress
  namespace: tenure
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
spec:
  tls:
    - hosts:
        - your-domain.com
        - api.your-domain.com
      secretName: tenure-tls
  rules:
    # Main UI
    - host: your-domain.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: ui
                port:
                  number: 3000
    # API Gateway (optional - route to specific services)
    - host: api.your-domain.com
      http:
        paths:
          - path: /subscription
            pathType: Prefix
            backend:
              service:
                name: subscription-service
                port:
                  number: 3001
          - path: /queue
            pathType: Prefix
            backend:
              service:
                name: queue-service
                port:
                  number: 3003
          - path: /kyc
            pathType: Prefix
            backend:
              service:
                name: kyc-service
                port:
                  number: 3002
          - path: /payout
            pathType: Prefix
            backend:
              service:
                name: payout-service
                port:
                  number: 3004
