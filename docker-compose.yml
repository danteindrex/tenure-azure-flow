# Docker Compose for Tenure Azure Flow
# Local development and testing environment

version: '3.8'

services:
  # Main Next.js UI Application
  ui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tenure-ui
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - BETTER_AUTH_URL=http://localhost:3000
      - NEXT_PUBLIC_QUEUE_SERVICE_URL=http://queue-service:3003
      - NEXT_PUBLIC_SUBSCRIPTION_SERVICE_URL=http://subscription-service:3001
      - QUEUE_SERVICE_URL=http://queue-service:3003
      - SUBSCRIPTION_SERVICE_URL=http://subscription-service:3001
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER}
      - TWILIO_VERIFY_SERVICE_SID=${TWILIO_VERIFY_SERVICE_SID}
    depends_on:
      - subscription-service
      - queue-service
      - kyc-service
      - payout-service
    networks:
      - tenure-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Subscription Service (Stripe payments)
  subscription-service:
    build:
      context: ./services/subscription-service
      dockerfile: Dockerfile
    container_name: tenure-subscription
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DATABASE_URL=${DATABASE_URL}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - FRONTEND_URL=http://localhost:3000
      - ALLOWED_ORIGINS=http://localhost:3000,http://ui:3000
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - EMAIL_FROM=${EMAIL_FROM}
      - EMAIL_FROM_NAME=${EMAIL_FROM_NAME}
    networks:
      - tenure-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Queue Service (Member queue management)
  queue-service:
    build:
      context: ./services/Tenure-queue
      dockerfile: Dockerfile
    container_name: tenure-queue
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=production
      - PORT=3003
      - DATABASE_URL=${DATABASE_URL}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - ALLOWED_ORIGINS=http://localhost:3000,http://ui:3000
    networks:
      - tenure-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3003/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # KYC Service (Identity verification via Plaid/Sumsub)
  kyc-service:
    build:
      context: ./services/kyc-service
      dockerfile: Dockerfile
    container_name: tenure-kyc
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - PORT=3002
      - DATABASE_URL=${DATABASE_URL}
      - KYC_PROVIDER=${KYC_PROVIDER:-sumsub}
      - PLAID_CLIENT_ID=${PLAID_CLIENT_ID}
      - PLAID_SECRET=${PLAID_SECRET}
      - PLAID_ENV=${PLAID_ENV:-sandbox}
      - PLAID_IDV_TEMPLATE_ID=${PLAID_IDV_TEMPLATE_ID}
      - SUMSUB_APP_TOKEN=${SUMSUB_APP_TOKEN}
      - SUMSUB_SECRET_KEY=${SUMSUB_SECRET_KEY}
      - SUMSUB_WEBHOOK_SECRET=${SUMSUB_WEBHOOK_SECRET}
      - SUMSUB_BASE_URL=${SUMSUB_BASE_URL:-https://api.sumsub.com}
      - SUMSUB_LEVEL_NAME=${SUMSUB_LEVEL_NAME:-Home solutions verify}
      - ALLOWED_ORIGINS=http://localhost:3000,http://ui:3000
    networks:
      - tenure-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3002/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Payout Service (Member rewards processing)
  payout-service:
    build:
      context: ./services/payout-service
      dockerfile: Dockerfile
    container_name: tenure-payout
    ports:
      - "3004:3004"
    environment:
      - NODE_ENV=production
      - PORT=3004
      - DATABASE_URL=${DATABASE_URL}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - EMAIL_FROM=${EMAIL_FROM}
      - ALLOWED_ORIGINS=http://localhost:3000,http://ui:3000
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET}
    networks:
      - tenure-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3004/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  tenure-network:
    driver: bridge

# Note: This setup expects environment variables to be provided via .env file
# Create a .env file in the root directory with all required variables
# Example:
# DATABASE_URL=postgresql://user:pass@host:5432/db
# STRIPE_SECRET_KEY=sk_test_xxx
# etc.
